<!-- Estilos específicos desta view -->
<style>
    :root {
        --bs-primary: #0d6efd;
    }

    .card {
        border-radius: 12px;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.03);
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
</style>

<div class="container py-4">
    <form action="/budgets/save" method="POST" id="budgetForm">
        <!-- CABEÇALHO -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary fw-bold mb-0">Novo Orçamento</h2>
                <p class="text-muted">Selecione os itens do catálogo para gerar o documento.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="/budgets" class="btn btn-outline-secondary px-4">Cancelar</a>
                <button type="submit" class="btn btn-primary px-4 shadow-sm">
                    <i class="bi bi-check-lg me-2"></i>Salvar Orçamento
                </button>
            </div>
        </div>

        <div class="row g-4">
            <!-- BLOCO A: Dados do Cliente -->
            <div class="col-lg-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 text-dark fw-bold">
                            <i class="bi bi-person-fill me-2 text-primary"></i>Informações do Cliente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Nome do Cliente / Empresa</label>
                                <input type="text" name="customerName" class="form-control" placeholder="Ex: João Silva" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">E-mail para contacto</label>
                                <input type="email" name="customerEmail" class="form-control" placeholder="exemplo@email.com" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Data de Emissão</label>
                                <input type="date" name="issueDate" id="issueDate" class="form-control" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Validade do Orçamento</label>
                                <select name="expiryDays" id="expiryDays" class="form-select">
                                    <option value="7">7 dias</option>
                                    <option value="15" selected>15 dias</option>
                                    <option value="30">30 dias</option>
                                    <option value="60">60 dias</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Estado Inicial</label>
                                <select name="status" class="form-select">
                                    <option value="Pending" selected>Pendente</option>
                                    <option value="Approved">Aprovado</option>
                                    <option value="Rejected">Rejeitado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BLOCO B: Grade de Itens -->
            <div class="col-lg-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-dark fw-bold">
                            <i class="bi bi-list-check me-2 text-primary"></i>Itens do Orçamento
                        </h5>
                        <button type="button" class="btn btn-sm btn-success px-3" id="btn-add-item">
                            <i class="bi bi-plus-lg me-1"></i>Adicionar Item
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="items-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 15%;">Tipo</th>
                                        <th style="width: 40%;">Produto / Serviço do Catálogo</th>
                                        <th style="width: 12%;">Qtd / Horas</th>
                                        <th style="width: 15%;">Preço Unit. (R$)</th>
                                        <th style="width: 13%;">Subtotal (R$)</th>
                                        <th style="width: 5%;"></th>
                                    </tr>
                                </thead>
                                <tbody id="items-body">
                                    <tr class="item-row">
                                        <td>
                                            <select name="items[0][itemType]" class="form-select form-select-sm input-type" readonly>
                                                <option value="Product">Produto</option>
                                                <option value="Service">Serviço</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="items[0][description]" class="form-select form-select-sm select-product" required>
                                                <option value="" selected disabled>Selecione um item...</option>
                                                {{#each products}}
                                                <option value="{{this.name}}" data-price="{{this.basePrice}}" data-type="{{this.itemType}}">
                                                    {{this.name}}
                                                </option>
                                                {{/each}}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="items[0][quantity]" class="form-control form-control-sm input-qty text-center" value="1" min="1" required />
                                        </td>
                                        <td>
                                            <input type="number" step="0.01" name="items[0][unitPrice]" class="form-control form-control-sm input-price text-end" placeholder="0.00" required />
                                        </td>
                                        <td class="text-end fw-bold">
                                            <span class="row-subtotal">R$ 0,00</span>
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-link text-danger p-0 btn-remove-row" disabled>
                                                <i class="bi bi-trash fs-5"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BLOCO C: Totais e Observações -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 text-dark fw-bold">Observações / Termos</h5>
                    </div>
                    <div class="card-body">
                        <textarea name="notes" class="form-control" rows="8" placeholder="Prazos de entrega, garantias, condições de pagamento..."></textarea>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 bg-white">
                    <div class="card-body py-4">
                        <h5 class="fw-bold mb-4 text-dark border-bottom pb-2">Resumo Financeiro</h5>
                        <div class="d-flex justify-content-between align-items-center py-2">
                            <span class="h5 mb-0 fw-bold">Total do Orçamento:</span>
                            <span class="h4 mb-0 text-primary fw-bold" id="summary-total">R$ 0,00</span>
                        </div>
                        <input type="hidden" name="totalAmount" id="hidden-total" value="0" />
                    </div>
                </div>
                <div class="alert alert-secondary mt-3 border-0 shadow-sm" style="border-radius: 12px;">
                    <small><i class="bi bi-info-circle me-2"></i>O valor total corresponde à soma bruta de todos os itens listados.</small>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Script isolado para processamento da view -->
<script>
    /**
     * Usamos uma IIFE (Immediately Invoked Function Expression) para isolar o escopo
     * e garantir que não haja conflitos com outras variáveis da página 'main'.
     */
    (function () {
        "use strict";

        const itemsBody = document.getElementById('items-body');
        const btnAddItem = document.getElementById('btn-add-item');
        const summaryTotal = document.getElementById('summary-total');
        const hiddenTotal = document.getElementById('hidden-total');

        let rowCount = 1;

        // Inicialização da data de hoje
        const initDate = function () {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('issueDate');
            if (dateInput) {
                dateInput.value = today;
            }
        };

        // Formatação para Real Brasileiro (R$)
        const formatCurrency = function (value) {
            return value.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        };

        // Função de cálculo dos totais da tabela
        const calculateTotals = function () {
            let grandTotal = 0;
            const rows = document.querySelectorAll('.item-row');

            rows.forEach(function (row) {
                const qtyInput = row.querySelector('.input-qty');
                const priceInput = row.querySelector('.input-price');
                const subtotalSpan = row.querySelector('.row-subtotal');

                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const subtotal = qty * price;

                if (subtotalSpan) {
                    subtotalSpan.textContent = formatCurrency(subtotal);
                }
                grandTotal += subtotal;
            });

            if (summaryTotal) {
                summaryTotal.textContent = formatCurrency(grandTotal);
            }
            if (hiddenTotal) {
                hiddenTotal.value = grandTotal.toFixed(2);
            }
        };

        // Handler para mudança de produto no catálogo
        const handleProductChange = function (e) {
            if (e.target.classList.contains('select-product')) {
                const row = e.target.closest('tr');
                const selectedOption = e.target.options[e.target.selectedIndex];

                const price = selectedOption.getAttribute('data-price');
                const type = selectedOption.getAttribute('data-type');

                if (price) {
                    row.querySelector('.input-price').value = price;
                }
                if (type) {
                    row.querySelector('.input-type').value = type;
                }

                calculateTotals();
            }
        };

        // Lógica para adicionar uma nova linha à tabela
        if (btnAddItem) {
            btnAddItem.addEventListener('click', function () {
                const rows = document.querySelectorAll('.item-row');
                if (rows.length === 0) return;

                const firstRow = rows[0];
                const newRow = firstRow.cloneNode(true);

                // Atualizar nomes dos inputs para o novo índice dinâmico
                newRow.querySelectorAll('input, select').forEach(function (el) {
                    const name = el.getAttribute('name');
                    if (name) {
                        el.setAttribute('name', name.replace(/\[\d+\]/, '[' + rowCount + ']'));
                    }

                    // Resetar os valores para a nova linha
                    if (el.classList.contains('input-qty')) {
                        el.value = '1';
                    } else if (el.classList.contains('select-product')) {
                        el.selectedIndex = 0;
                    } else if (el.tagName === 'INPUT') {
                        el.value = '';
                    }
                });

                // Resetar o subtotal visual
                const subtotalSpan = newRow.querySelector('.row-subtotal');
                if (subtotalSpan) {
                    subtotalSpan.textContent = 'R$ 0,00';
                }

                // Configurar o botão remover para a nova linha
                const removeBtn = newRow.querySelector('.btn-remove-row');
                if (removeBtn) {
                    removeBtn.disabled = false;
                    removeBtn.addEventListener('click', function () {
                        newRow.remove();
                        calculateTotals();
                    });
                }

                itemsBody.appendChild(newRow);
                rowCount++;
                calculateTotals();
            });
        }

        // Delegação de eventos para mudanças na tabela (Inputs e Selects)
        if (itemsBody) {
            itemsBody.addEventListener('change', handleProductChange);
            itemsBody.addEventListener('input', function (e) {
                if (e.target.classList.contains('input-qty') || e.target.classList.contains('input-price')) {
                    calculateTotals();
                }
            });
        }

        // Configurar botões remover existentes no carregamento
        document.querySelectorAll('.btn-remove-row').forEach(function (btn) {
            btn.addEventListener('click', function () {
                if (document.querySelectorAll('.item-row').length > 1) {
                    btn.closest('tr').remove();
                    calculateTotals();
                }
            });
        });

        // Execução inicial
        initDate();
        calculateTotals();
    })();
</script>