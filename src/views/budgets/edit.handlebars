<div class="container pb-5 animate-fade-in">
  <form action="/budgets/update/{{budget.id}}" method="POST" id="editForm">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <a href="/budgets" class="text-decoration-none text-muted small">
          <i class="bi bi-arrow-left me-1"></i> Voltar para a lista
        </a>
        <h2 class="fw-bold mb-0 mt-1">
          Editar Orçamento <span class="text-primary">#{{budget.id}}</span>
        </h2>
      </div>
      <div class="d-flex gap-2">
        <a href="/budgets" class="btn btn-outline-secondary px-4">Cancelar</a>
        <button type="submit" class="btn btn-primary px-4 shadow-sm">
          <i class="bi bi-save me-2"></i>Atualizar Orçamento
        </button>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="fw-bold mb-4 text-primary">Informações do Cliente</h5>
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label small fw-bold text-muted">NOME DO CLIENTE / EMPRESA</label>
                <input type="text" name="customerName" class="form-control" value="{{budget.customerName}}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-bold text-muted">ESTADO ATUAL</label>
                <select name="status" class="form-select fw-bold">
                  <option value="Pending" {{#if (eq budget.status "Pending" )}}selected{{/if}}>Pendente</option>
                  <option value="Approved" {{#if (eq budget.status "Approved" )}}selected{{/if}}>Aprovado</option>
                  <option value="Rejected" {{#if (eq budget.status "Rejected" )}}selected{{/if}}>Rejeitado</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">E-MAIL</label>
                <input type="email" name="customerEmail" class="form-control" value="{{budget.customerEmail}}">
              </div>
              <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">DATA DE EMISSÃO</label>
                <input type="date" name="issueDate" class="form-control" value="{{budget.issueDate}}" required>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="fw-bold mb-0 text-primary">Itens e Serviços</h5>
              <button type="button" onclick="addRow()" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-plus-lg me-1"></i>Adicionar Item
              </button>
            </div>

            <div class="table-responsive">
              <table class="table align-middle" id="itemsTable">
                <thead class="table-light small fw-bold text-uppercase">
                  <tr>
                    <th>Descrição</th>
                    <th style="width: 100px;">Qtd</th>
                    <th style="width: 160px;">Unitário (R$)</th>
                    <th style="width: 160px;" class="text-end text-primary">Subtotal</th>
                    <th style="width: 50px;"></th>
                  </tr>
                </thead>
                <tbody id="itemsBody">
                  {{#each items}}
                  <tr class="item-row">
                    <td>
                      <input type="text" name="items[{{@index}}][description]" class="form-control form-control-sm" value="{{this.description}}" required>
                    </td>
                    <td>
                      <input type="number" name="items[{{@index}}][quantity]" class="form-control form-control-sm qty-input text-center" value="{{this.quantity}}" min="1" oninput="calculate()">
                    </td>
                    <td>
                      <input type="number" step="0.01" name="items[{{@index}}][price]" class="form-control form-control-sm price-input text-end" value="{{this.unitPrice}}" oninput="calculate()">
                    </td>
                    <td class="text-end fw-bold row-subtotal">
                      {{formatCurrency this.subtotal}}
                    </td>
                    <td class="text-center">
                      <button type="button" class="btn btn-link text-danger p-0" onclick="removeRow(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm border-0 sticky-top" style="top: 100px;">
          <div class="card-body py-4">
            <label class="form-label small fw-bold text-muted text-uppercase mb-2">Total Atualizado</label>
            <h2 class="fw-bold text-primary mb-4" id="grandTotalDisplay">{{formatCurrency budget.totalAmount}}</h2>
            <input type="hidden" name="totalAmount" id="hiddenTotalAmount" value="{{budget.totalAmount}}">

            <div class="mb-4">
              <label class="form-label small fw-bold text-muted text-uppercase">Observações Internas</label>
              <textarea name="notes" class="form-control" rows="6" placeholder="Notas sobre a negociação...">{{budget.notes}}</textarea>
            </div>

            <div class="alert alert-secondary border-0 small mb-0">
              <i class="bi bi-info-circle me-2"></i>
              As alterações nos itens substituirão permanentemente a lista anterior deste orçamento.
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
  /**
   * Calcula subtotais e total geral em tempo real
   */
  function calculate() {
    let totalGeral = 0;
    const rows = document.querySelectorAll('.item-row');

    rows.forEach(row => {
      const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
      const price = parseFloat(row.querySelector('.price-input').value) || 0;
      const subtotal = qty * price;

      row.querySelector('.row-subtotal').innerText = subtotal.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });

      totalGeral += subtotal;
    });

    document.getElementById('grandTotalDisplay').innerText = totalGeral.toLocaleString('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    });
    document.getElementById('hiddenTotalAmount').value = totalGeral.toFixed(2);
  }

  /**
   * Adiciona nova linha de item mantendo a indexação correta para o Sequelize
   */
  let rowIndex = {{items.length}};

  function addRow() {
    const body = document.getElementById('itemsBody');
    const rows = document.querySelectorAll('.item-row');

    // Clona a primeira linha como modelo
    const newRow = rows[0].cloneNode(true);

    // Limpa e ajusta nomes dos inputs
    newRow.querySelectorAll('input').forEach(input => {
      const name = input.getAttribute('name');
      if (name) {
        input.setAttribute('name', name.replace(/\[\d+\]/, `[${rowIndex}]`));
      }
      input.value = input.type === 'number' ? (input.classList.contains('qty-input') ? 1 : 0) : '';
    });

    newRow.querySelector('.row-subtotal').innerText = 'R$ 0,00';
    body.appendChild(newRow);

    rowIndex++;
    calculate();
  }

  /**
   * Remove linha e recalcula
   */
  function removeRow(btn) {
    if (document.querySelectorAll('.item-row').length > 1) {
      btn.closest('tr').remove();
      calculate();
    } else {
      alert('O orçamento deve conter pelo menos um item.');
    }
  }

  // Inicializa o cálculo ao carregar (para garantir formatação correta)
  window.onload = calculate;
</script>